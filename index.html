<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Burger Shot Order Calculator</title>
  <!-- Favicon (swap to your Burger Shot icon if you have one) -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/vxBK9r5R/BM.png">
  <meta name="theme-color" content="#0b2e70">
  <style>
    :root {
      /* Burger Shot palette: red / blue / white */
      --red:#d62828;
      --blue:#0b2e70;
      --white:#fdfdfd;
      --ink:#111827;
      --muted:#6b7280;

      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.10);

      --bg:#f3f4ff;
      --panel:#ffffff;
      --card:#ffffff;
      --chip:#eef2ff;
      --text:var(--ink);
      --accent:var(--red);
      --radius:16px;

      --bg-dark:#020617;
      --panel-dark:#020617;
      --card-dark:#050816;
      --chip-dark:#111827;
      --text-dark:#e5e7eb;
      --border-dark:#1f2937;
    }

    [data-theme="dark"]{
      --bg:var(--bg-dark);
      --panel:var(--panel-dark);
      --card:var(--card-dark);
      --chip:var(--chip-dark);
      --text:var(--text-dark);
      --border:var(--border-dark);
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,Cantarell,"Noto Sans",Arial;
    }
    h1,h2,h3,h4{
      font-family:Georgia,"Times New Roman",serif;
      letter-spacing:.2px;
    }
    .container{
      max-width:1200px;
      margin:32px auto;
      padding:0 16px;
    }
    header{
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand .logo{
      width:52px;height:52px;
      border-radius:14px;
      box-shadow:var(--shadow);
      position:relative;
      background:conic-gradient(from 220deg,
        var(--blue) 0 33%,var(--white) 33% 66%,var(--red) 66% 100%);
    }
    .brand .logo::after{
      content:"üçî";
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      font-size:26px;
    }
    .brand h1{
      margin:0;
      font-size:1.4rem;
      letter-spacing:.3px;
    }
    .grid{
      display:grid;
      grid-template-columns:1.2fr .8fr;
      gap:20px;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;}
    }
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
    }
    .panel h2{
      margin:0;
      padding:16px 18px;
      font-size:1rem;
      border-bottom:1px solid var(--border);
    }
    .panel .content{padding:16px;}
    .section{margin-bottom:16px;}
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:12px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .card h3{margin:0;font-size:1rem;}
    .price{color:var(--accent);font-weight:700;}
    .muted{color:var(--muted);font-size:.9rem;}
    .qty{
      display:grid;
      grid-template-columns:32px 1fr 32px;
      align-items:center;
      gap:8px;
      margin-top:6px;
    }
    .qty button{
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--text);
      cursor:pointer;
      font-size:18px;
    }
    .qty output{text-align:center;}
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--chip);
      color:var(--text);
      cursor:pointer;
      font-weight:600;
      text-decoration:none;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--red),var(--blue));
      border:none;
      color:#fff;
    }
    .btn.block{width:100%;}
    .btn.ghost{background:transparent;}
    .toolrow{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid var(--border);
      color:var(--muted);
      font-weight:700;
      font-size:.85rem;
    }
    .divider{height:1px;background:var(--border);margin:8px 0;}
    .summary{display:flex;flex-direction:column;gap:14px;}
    .summary .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .summary .row.total{
      font-size:1.2rem;
      font-weight:800;
    }
    .discount{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
    }
    .discount input[type="range"]{width:100%;}
    .kbd{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      background:transparent;
      border:2px solid var(--blue);
      color:var(--blue);
      border-radius:8px;
      padding:4px 8px;
      font-weight:800;
    }
    .order-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:6px;
    }
    .cart-item{
      display:grid;
      grid-template-columns:1fr auto auto;
      gap:10px;
      align-items:center;
      padding:8px;
      border-bottom:1px dashed var(--border);
    }
    .cart-item:last-child{border-bottom:none;}
    .small{font-size:.85rem;color:var(--muted);}
    .tabs{display:flex;gap:8px;margin-bottom:10px;}
    .tabs .btn[aria-selected="true"]{outline:2px solid var(--accent);}
    dialog{
      width:min(760px,92vw);
      background:var(--panel);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:18px;
      padding:0;
    }
    dialog::backdrop{background:rgba(0,0,0,.6);}
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid var(--border);
    }
    .modal-body{
      padding:16px;
      display:grid;
      gap:18px;
    }
    .option{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card);
    }
    .selector-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:10px;
    }
    .select-card{
      border:1px solid var(--border);
      background:var(--card);
      border-radius:12px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .select-title{font-weight:700;}
    .select-qty{
      display:grid;
      grid-template-columns:32px 1fr 32px;
      align-items:center;
      gap:8px;
    }
    .select-qty button{
      height:32px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--chip);
      cursor:pointer;
    }
    .ing-list{
      display:grid;
      grid-template-columns:1fr auto;
      gap:8px;
    }
    .ing-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Burger Shot Order Calculator</h1>
          <div class="muted">
            Ring up combos, burgers, drinks, shakes & ice cream and get an exact total (with recipes).
          </div>
        </div>
      </div>
      <div class="toolrow">
        <span class="chip">Autosaves</span>
        <button class="btn ghost" id="themeBtn" aria-pressed="false" title="Toggle dark mode">üåô Dark</button>
        <button class="btn ghost" id="resetBtn">Clear All</button>
        <button class="btn primary" id="checkoutBtn">Checkout</button>
      </div>
    </header>

    <!-- red / white / blue flag bar -->
    <div class="flagbar" aria-hidden="true" style="height:10px;border-radius:8px;overflow:hidden;margin-bottom:18px;">
      <div style="display:flex;height:100%;">
        <div style="flex:1;background:var(--red)"></div>
        <div style="flex:1;background:var(--white)"></div>
        <div style="flex:1;background:var(--blue)"></div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: Menu -->
      <section class="panel">
        <h2>Menu</h2>
        <div class="content">
          <div class="section">
            <h3 style="margin:0 0 8px 0">Combos</h3>
            <div class="cards" id="combos"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Entrees</h3>
            <div class="cards" id="entrees"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Drinks</h3>
            <div class="cards" id="drinks"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Shakes</h3>
            <div class="cards" id="shakes"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Ice Cream</h3>
            <div class="cards" id="iceCream"></div>
          </div>

          <div class="section">
            <h3 style="margin:0 0 8px 0">Extras</h3>
            <div class="cards" id="extras"></div>
          </div>
        </div>
      </section>

      <!-- Right: Orders -->
      <aside class="panel">
        <h2>Orders</h2>
        <div class="content">
          <div class="tabs" role="tablist" aria-label="Order panels">
            <button class="btn" data-tab="summary" aria-selected="true">üßæ Summary</button>
            <button class="btn" data-tab="history" aria-selected="false">üìú History</button>
            <button class="btn" data-tab="ingredients" aria-selected="false">üß∫ Ingredients</button>
          </div>

          <!-- SUMMARY TAB -->
          <div id="tab-summary" role="tabpanel">
            <div class="option" style="margin-bottom:10px;">
              <div>
                <div><strong>Fulfillment</strong></div>
                <div class="small">City $50 ¬∑ Sandy $100 ¬∑ Paleto $150</div>
              </div>
              <div style="display:flex; gap:10px; align-items:center;">
                <label><input type="radio" name="fulfill" value="pickup"> Pickup</label>
                <label><input type="radio" name="fulfill" value="delivery"> Delivery</label>
                <select id="zoneSelect" style="margin-left:6px;">
                  <option value="city">City</option>
                  <option value="sandy">Sandy</option>
                  <option value="paleto">Paleto</option>
                </select>
              </div>
            </div>

            <div id="cart" class="order-card">
              <div class="cart-item muted">Your order is empty. Add a combo or entree to get started.</div>
            </div>

            <div class="divider"></div>

            <div class="discount">
              <label for="discountRange">Discount</label>
              <div><span id="discountLabel" class="kbd">0%</span></div>
              <input id="discountRange" type="range" min="0" max="100" step="5" value="0" />
            </div>

            <div class="summary" style="margin-top:12px;">
              <div class="row"><span>Subtotal</span><strong id="subtotal">$0.00</strong></div>
              <div class="row" id="deliveryRow" style="display:none;"><span>Delivery Fee</span><strong id="deliveryFee">$0.00</strong></div>
              <div class="row"><span>Discount</span><strong id="discount">-$0.00</strong></div>
              <div class="row"><span>Promotions</span><strong id="promotions">-$0.00</strong></div>
              <div class="row total"><span>Total</span><strong id="total">$0.00</strong></div>
              <div class="small" id="promoNotes"></div>
            </div>

            <div class="right-actions" style="margin-top:12px;">
              <button class="btn primary block" id="checkoutBtn2">Checkout</button>
              <button class="btn ghost block" id="resetBtn2">Clear All</button>
            </div>
          </div>

          <!-- HISTORY TAB -->
          <div id="tab-history" role="tabpanel" hidden>
            <div id="historyList" class="summary" style="gap:12px;"></div>
            <div class="right-actions" style="margin-top:12px;">
              <button class="btn ghost" id="clearHistoryBtn">Clear History</button>
            </div>
          </div>

          <!-- INGREDIENTS TAB -->
          <div id="tab-ingredients" role="tabpanel" hidden>
            <div class="small muted" style="margin-bottom:6px;">
              Auto-aggregated from your current cart using each item's recipe and combo selections.
            </div>
            <div id="ingredientList" class="order-card" style="padding:12px;">
              <div class="muted">No ingredients yet. Add items to the cart.</div>
            </div>
            <div class="ing-actions" style="margin-top:10px;">
              <button class="btn" id="copyIngBtn">Copy List</button>
              <button class="btn" id="exportIngBtn">Export CSV</button>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Combo Drink Selector Modal -->
  <dialog id="comboModal">
    <div class="modal-header">
      <strong id="comboTitle">Choose Drinks</strong>
      <button class="btn" id="closeCombo" aria-label="Close">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="comboSteps"></div>
      <div id="comboContent"></div>
      <div class="toolrow" style="justify-content:flex-end; margin-top:6px;">
        <button class="btn" id="comboPrev" style="display:none;">Back</button>
        <button class="btn primary" id="comboNext">Next</button>
      </div>
    </div>
  </dialog>

  <script>
    // ---------- Data ----------

    const MENU = {
      combos: [
        {
          id:'cb-nuglife',
          name:'Nug Life',
          price:250,
          type:'combo',
          drinksIncluded:4,
          includedEntrees:{ 'en-nuggets':2, 'en-fries':2 },
          description:'2x Chicken Nuggets ‚Ä¢ 2x Fries ‚Ä¢ 4 Drinks of choice'
        },
        {
          id:'cb-plainjane',
          name:'Plain Jane',
          price:200,
          type:'combo',
          drinksIncluded:4,
          includedEntrees:{ 'en-ham':2, 'en-fries':2 },
          description:'2x Hamburgers ‚Ä¢ 2x Fries ‚Ä¢ 4 Drinks of choice'
        },
        {
          id:'cb-meltdown',
          name:'The Meltdown',
          price:250,
          type:'combo',
          drinksIncluded:4,
          includedEntrees:{ 'en-cheese':2, 'en-fries':2 },
          description:'2x Cheeseburgers ‚Ä¢ 2x Fries ‚Ä¢ 4 Drinks of choice'
        },
        {
          id:'cb-porker',
          name:'The Porker',
          price:350,
          type:'combo',
          drinksIncluded:4,
          includedEntrees:{ 'en-bacon':2, 'en-fries':2 },
          description:'2x Bacon Cheeseburgers ‚Ä¢ 2x Fries ‚Ä¢ 4 Drinks of choice'
        },
        {
          id:'cb-brawler',
          name:`The Breakfast Brawler`,
          price:450,
          type:'combo',
          drinksIncluded:4,
          includedEntrees:{ 'en-breakfast':2, 'en-fries':2 },
          description:`2x Bacon n' Egg Cheeseburgers ‚Ä¢ 2x Fries ‚Ä¢ 4 Drinks of choice`
        },
        {
          id:'cb-gobbler',
          name:'Garden Gobbler',
          price:200,
          type:'combo',
          drinksIncluded:4,
          includedEntrees:{ 'en-veggie':2, 'en-fries':2 },
          description:'2x Veggie Burgers ‚Ä¢ 2x Fries ‚Ä¢ 4 Drinks of choice'
        },
        // Adult Toy combo: handled in practice as meal + Adult Toy + manual discount,
        // so no special logic here to avoid over-complicating.
      ],

      entrees: [
        { id:'en-nuggets',    name:'Chicken Nuggets',           price:60,  type:'entree' },
        { id:'en-ham',        name:'Hamburger',                 price:60,  type:'entree' },
        { id:'en-cheese',     name:'Cheeseburger',              price:100, type:'entree' },
        { id:'en-bacon',      name:'Bacon Cheeseburger',        price:120, type:'entree' },
        { id:'en-breakfast',  name:`Bacon n' Egg Cheeseburger`, price:140, type:'entree' },
        { id:'en-veggie',     name:'Veggie Burger',             price:60,  type:'entree' },
        { id:'en-fries',      name:'Fries',                     price:60,  type:'entree' },
      ],

      drinks: [
        { id:'dr-water',      name:'Water',        price:50, type:'drink' },
        { id:'dr-koka',       name:'Koka',         price:50, type:'drink' },
        { id:'dr-frezzi',     name:'Frezzi',       price:50, type:'drink' },
        { id:'dr-sprunk',     name:'Sprunk',       price:50, type:'drink' },
        { id:'dr-tanga',      name:'Tanga',        price:50, type:'drink' },
        { id:'dr-greenapple', name:'Green Apple',  price:50, type:'drink' },
      ],

      shakes: [
        { id:'shk-vanilla', name:'Vanilla Shake',  price:100, type:'shake' },
        { id:'shk-choc',    name:'Chocolate Shake',price:100, type:'shake' },
        { id:'shk-avo',     name:'Avocado Shake',  price:100, type:'shake' },
        { id:'shk-banana',  name:'Banana Shake',   price:100, type:'shake' },
      ],

      iceCream: [
        { id:'ic-vanilla',    name:'Vanilla Ice Cream',     price:100, type:'ice' },
        { id:'ic-choc',       name:'Chocolate Ice Cream',   price:100, type:'ice' },
        { id:'ic-apple',      name:'Apple Ice Cream',       price:100, type:'ice' },
        { id:'ic-banana',     name:'Banana Ice Cream',      price:100, type:'ice' },
        { id:'ic-lemon',      name:'Lemon Ice Cream',       price:100, type:'ice' },
        { id:'ic-mango',      name:'Mango Ice Cream',       price:100, type:'ice' },
        { id:'ic-pomegranate',name:'Pomegranate Ice Cream', price:100, type:'ice' },
        { id:'ic-watermelon', name:'Watermelon Ice Cream',  price:100, type:'ice' },
      ],

      extras: [
        { id:'ex-toy', name:'Adult Toy', price:1000, type:'extra' },
      ],

      specialty:[], deals:[], packs:[]
    };

    // ---------- Recipes (for ingredient list) ----------

    const RECIPE_MAP = {
      // Entrees
      'en-ham':       {'Burger Buns':1,'Raw Patty':1,'Lettuce':1},
      'en-cheese':    {'Burger Buns':1,'Raw Patty':1,'Lettuce':1,'Cheese':1},
      'en-bacon':     {'Burger Buns':1,'Raw Patty':1,'Lettuce':1,'Cheese':1,'Raw Bacon':1},
      'en-breakfast': {'Burger Buns':1,'Raw Patty':1,'Lettuce':1,'Cheese':1,'Raw Bacon':1,'Eggs':1},
      'en-veggie':    {'Burger Buns':1,'Lettuce':4},
      'en-nuggets':   {'Breadcrumbs':1,'Chicken Breast':1},
      'en-fries':     {'Potato':3},

      // Drinks (bought finished)
      'dr-water':      {'Water':1},
      'dr-koka':       {'Koka':1},
      'dr-frezzi':     {'Frezzi':1},
      'dr-sprunk':     {'Sprunk':1},
      'dr-tanga':      {'Tanga':1},
      'dr-greenapple': {'Green Apple':1},

      // Ice cream (1 Cone + 1 Milk + 1 flavour)
      'ic-vanilla':    {'Ice Cream Cone':1,'Milk':2},                 // treat milk as base+flavour
      'ic-choc':       {'Ice Cream Cone':1,'Milk':1,'Cocoa Powder':1},
      'ic-apple':      {'Ice Cream Cone':1,'Milk':1,'Apple':1},
      'ic-banana':     {'Ice Cream Cone':1,'Milk':1,'Banana':1},
      'ic-lemon':      {'Ice Cream Cone':1,'Milk':1,'Lemon':1},
      'ic-mango':      {'Ice Cream Cone':1,'Milk':1,'Mango':1},
      'ic-pomegranate':{'Ice Cream Cone':1,'Milk':1,'Pomegranate':1},
      'ic-watermelon': {'Ice Cream Cone':1,'Milk':1,'Watermelon':1},

      // Shakes (2 Milk + 3 flavour, except Avocado special)
      'shk-vanilla': {'Milk':2},                            // flavour handled at bench
      'shk-choc':    {'Milk':2,'Cocoa Powder':3},
      'shk-avo':     {'Avocado':2},
      'shk-banana':  {'Milk':2,'Banana':3},

      // Adult Toy
      'ex-toy':      {'Adult Surprise':1},
    };

    const currency = n => `$${n.toFixed(2)}`;

    // ---------- State ----------

    const STATE_KEY = 'burgershot_state_v1';
    const HIST_KEY  = 'burgershot_history_v1';

    const state = {
      cart:[],
      discountPct:0,
      history:[],
      fulfillment:'pickup',
      deliveryZone:'city'
    };

    try{
      const saved = JSON.parse(localStorage.getItem(STATE_KEY)||'{}');
      const savedHist = JSON.parse(localStorage.getItem(HIST_KEY)||'[]');
      if(Array.isArray(savedHist)) state.history = savedHist;
      if(saved){
        if(Array.isArray(saved.cart)) state.cart = saved.cart;
        if(typeof saved.discountPct==='number') state.discountPct = saved.discountPct;
        if(saved.fulfillment) state.fulfillment = saved.fulfillment;
        if(saved.deliveryZone) state.deliveryZone = saved.deliveryZone;
      }
    }catch{}

    const persist = () => localStorage.setItem(STATE_KEY, JSON.stringify(state));
    const persistHistory = () => localStorage.setItem(HIST_KEY, JSON.stringify(state.history));

    // ---------- Helpers ----------

    function findMenuItem(id){
      const pools = [
        MENU.combos, MENU.entrees, MENU.drinks, MENU.shakes,
        MENU.iceCream, MENU.extras, MENU.specialty, MENU.deals, MENU.packs
      ];
      for(const pool of pools){
        const f = pool.find(x=>x.id===id);
        if(f) return f;
      }
      return null;
    }

    function getMealDrinkPool(){
      return MENU.drinks;
    }

    // ---------- Card Rendering ----------

    function cardHTML(item){
      const needsCombo = (item.drinksIncluded||0)>0;
      return `
        <article class="card">
          <h3>${item.name}</h3>
          ${item.description ? `<div class="muted">${item.description}</div>` : ''}
          <div class="toolrow" style="justify-content:space-between;">
            <span class="price">${currency(item.price)}</span>
            <div class="qty">
              <button aria-label="decrease">‚àí</button>
              <output>1</output>
              <button aria-label="increase">+</button>
            </div>
          </div>
          ${needsCombo
            ? `<button class="btn" data-wizard="${item.id}">Choose Drinks &amp; Add</button>`
            : `<button class="btn" data-add="${item.id}">Add</button>`}
        </article>`;
    }

    function renderCards(){
      const combos   = document.getElementById('combos');
      const entrees  = document.getElementById('entrees');
      const drinks   = document.getElementById('drinks');
      const shakes   = document.getElementById('shakes');
      const iceCream = document.getElementById('iceCream');
      const extras   = document.getElementById('extras');

      const make = arr => arr.map(cardHTML).join('');
      combos.innerHTML   = make(MENU.combos);
      entrees.innerHTML  = make(MENU.entrees);
      drinks.innerHTML   = make(MENU.drinks);
      shakes.innerHTML   = make(MENU.shakes);
      iceCream.innerHTML = make(MENU.iceCream);
      extras.innerHTML   = make(MENU.extras);

      const allItems = [
        ...MENU.combos,...MENU.entrees,...MENU.drinks,
        ...MENU.shakes,...MENU.iceCream,...MENU.extras
      ];

      document.querySelectorAll('.cards .card').forEach(card=>{
        let count=1;
        const out=card.querySelector('output');
        card.querySelector('button[aria-label="decrease"]')?.addEventListener('click',()=>{
          count=Math.max(1,count-1);out.value=count;
        });
        card.querySelector('button[aria-label="increase"]')?.addEventListener('click',()=>{
          count++;out.value=count;
        });

        const wizId = card.querySelector('[data-wizard]')?.getAttribute('data-wizard');
        if(wizId){
          const item = allItems.find(i=>i.id===wizId);
          card.querySelector('[data-wizard]').addEventListener('click',()=>openComboWizard(item,count));
          return;
        }

        const addId = card.querySelector('[data-add]')?.getAttribute('data-add');
        if(addId){
          const item = allItems.find(i=>i.id===addId);
          card.querySelector('[data-add]').addEventListener('click',()=>{
            addToCart({
              id:item.id,
              name:item.name,
              unitPrice:item.price,
              qty:count,
              type:item.type
            });
          });
        }
      });
    }

    // ---------- Cart ----------

    function renderCart(){
      const cart = document.getElementById('cart');
      if(!state.cart.length){
        cart.innerHTML =
          `<div class="cart-item muted">Your order is empty. Add a combo or entree to get started.</div>`;
        return;
      }
      cart.innerHTML = state.cart.map((l,idx)=>`
        <div class="cart-item">
          <div>
            <div><strong>${l.name}</strong></div>
            <div class="small">${currency(l.unitPrice)} each${l.meta?` ‚Ä¢ ${l.meta}`:''}</div>
          </div>
          <div class="qty">
            <button data-dec="${idx}">‚àí</button>
            <output>${l.qty}</output>
            <button data-inc="${idx}">+</button>
          </div>
          <div><strong>${currency(l.unitPrice*l.qty)}</strong></div>
        </div>
      `).join('');

      cart.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',()=>{
        const i=+b.getAttribute('data-inc');
        state.cart[i].qty++;
        persist();
        renderCart();
        renderTotals();
        renderIngredients();
      }));
      cart.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',()=>{
        const i=+b.getAttribute('data-dec');
        state.cart[i].qty--;
        if(state.cart[i].qty<=0) state.cart.splice(i,1);
        persist();
        renderCart();
        renderTotals();
        renderIngredients();
      }));
    }

    function addToCart(line){
      const key = `${line.id||line.name}|${line.unitPrice}|${line.type||''}|${(line.meta||'')}`;
      const found = state.cart.find(l =>
        `${l.id||l.name}|${l.unitPrice}|${l.type||''}|${(l.meta||'')}`===key &&
        JSON.stringify(l.drinks||{})===JSON.stringify(line.drinks||{}) &&
        JSON.stringify(l.cakes||{})===JSON.stringify(line.cakes||{})
      );
      if(found) found.qty += line.qty;
      else state.cart.push(line);

      persist();
      renderCart();
      renderTotals();
      renderIngredients();
    }

    // ---------- Fulfillment ----------

    const ZONE_FEES = { city:50, sandy:100, paleto:150 };

    function renderFulfillment(){
      document.querySelectorAll('input[name="fulfill"]').forEach(r=>{
        r.checked = (r.value===state.fulfillment);
      });
      const zoneSel=document.getElementById('zoneSelect');
      zoneSel.value=state.deliveryZone;
      zoneSel.disabled = state.fulfillment!=='delivery';
    }

    document.querySelectorAll('input[name="fulfill"]').forEach(r=>{
      r.addEventListener('change', e=>{
        state.fulfillment=e.target.value;
        persist();
        renderFulfillment();
        renderTotals();
      });
    });

    document.getElementById('zoneSelect').addEventListener('change', e=>{
      state.deliveryZone=e.target.value;
      persist();
      renderTotals();
    });

    // ---------- Promotions (none for now; weekly deals TBD) ----------

    function computePromotions(){
      return { discount:0, notes:[] };
    }

    // ---------- Totals ----------

    function renderTotals(){
      const subtotal = state.cart.reduce((s,l)=>s + l.unitPrice*l.qty, 0);
      const manual = +(subtotal * (state.discountPct/100)).toFixed(2);
      const promo = computePromotions();
      const deliveryFee = state.fulfillment==='delivery'
        ? (ZONE_FEES[state.deliveryZone]||0)
        : 0;
      const total = subtotal + deliveryFee - manual - promo.discount;

      document.getElementById('subtotal').textContent = currency(subtotal);
      document.getElementById('discount').textContent = `-${currency(manual)}`;
      document.getElementById('promotions').textContent = `-${currency(promo.discount)}`;
      document.getElementById('total').textContent = currency(total);
      document.getElementById('promoNotes').textContent = promo.notes.join(' ‚Ä¢ ');

      const row = document.getElementById('deliveryRow');
      if(deliveryFee>0){
        row.style.display='flex';
        document.getElementById('deliveryFee').textContent = currency(deliveryFee);
      }else{
        row.style.display='none';
        document.getElementById('deliveryFee').textContent = currency(0);
      }
    }

    // ---------- Discount slider ----------

    const range=document.getElementById('discountRange');
    const discountLabel=document.getElementById('discountLabel');

    function renderDiscount(){
      range.value=state.discountPct;
      discountLabel.textContent = `${state.discountPct}%`;
    }

    range.addEventListener('input',()=>{
      state.discountPct=+range.value;
      persist();
      renderTotals();
      discountLabel.textContent = `${state.discountPct}%`;
    });

    // ---------- History ----------

    function renderHistory(){
      const list=document.getElementById('historyList');
      if(!state.history.length){
        list.innerHTML='<div class="muted">No past orders yet. Checkout to save one.</div>';
        return;
      }
      list.innerHTML = state.history.map(h=>`
        <article class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div><strong>${new Date(h.id).toLocaleString()}</strong></div>
              <div class="small">${h.items.length} item(s) ‚Ä¢ Discount ${h.discountPct}%</div>
            </div>
            <div><strong>${currency(h.total)}</strong></div>
          </div>
          <details class="small" style="margin-top:6px;">
            <summary>View items</summary>
            <ul style="margin:6px 0 0 16px;">
              ${h.items.map(i=>`
                <li>${i.qty}√ó ${i.name}${i.meta?` <span class="small">(${i.meta})</span>`:''}
                 ‚Äî ${currency(i.lineTotal)}</li>`).join('')}
            </ul>
          </details>
          <div class="toolrow" style="justify-content:flex-end;">
            <button class="btn" data-reorder="${h.id}">Reorder</button>
            <button class="btn ghost" data-delete="${h.id}">Delete</button>
          </div>
        </article>
      `).join('');

      list.querySelectorAll('[data-reorder]').forEach(btn=>btn.addEventListener('click',()=>{
        const id=+btn.getAttribute('data-reorder');
        const h=state.history.find(x=>x.id===id);
        if(!h) return;
        h.items.forEach(it =>{
          addToCart({
            id:it.id||null,
            name:it.name,
            unitPrice:it.unit,
            qty:it.qty,
            meta:it.meta||null,
            drinks:it.drinks||null,
            cakes:it.cakes||null,
            type:it.type||'extra'
          });
        });
      }));

      list.querySelectorAll('[data-delete]').forEach(btn=>btn.addEventListener('click',()=>{
        const id=+btn.getAttribute('data-delete');
        state.history = state.history.filter(x=>x.id!==id);
        persistHistory();
        renderHistory();
      }));
    }

    document.getElementById('clearHistoryBtn').addEventListener('click',()=>{
      if(confirm('Clear all saved orders?')){
        state.history=[];
        persistHistory();
        renderHistory();
      }
    });

    // ---------- Tabs ----------

    const tabButtons=document.querySelectorAll('[data-tab]');

    function selectTab(which){
      document.getElementById('tab-summary').hidden = which!=='summary';
      document.getElementById('tab-history').hidden = which!=='history';
      document.getElementById('tab-ingredients').hidden = which!=='ingredients';
      tabButtons.forEach(b=>b.setAttribute(
        'aria-selected',
        String(b.getAttribute('data-tab')===which)
      ));
      if(which==='ingredients') renderIngredients();
      if(which==='history') renderHistory();
    }

    tabButtons.forEach(b=>b.addEventListener('click',()=>{
      selectTab(b.getAttribute('data-tab'));
    }));

    // ---------- Combo wizard (drinks for combos) ----------

    const comboModal   = document.getElementById('comboModal');
    const comboTitle   = document.getElementById('comboTitle');
    const comboSteps   = document.getElementById('comboSteps');
    const comboContent = document.getElementById('comboContent');
    const comboPrev    = document.getElementById('comboPrev');
    const comboNext    = document.getElementById('comboNext');

    document.getElementById('closeCombo').addEventListener('click',()=>comboModal.close());

    function openComboWizard(item, qty){
      const usedTotal = (counts) => Object.values(counts).reduce((a,b)=>a+b,0);
      const drinksNeeded = item.drinksIncluded || 0;
      const pool = getMealDrinkPool();
      const counts = {};
      let confirmMode=false;

      const renderGrid=()=>{
        const used = usedTotal(counts);
        const remaining = drinksNeeded - used;
        comboTitle.textContent = `Drinks: pick ${drinksNeeded} (remaining ${Math.max(0,remaining)})`;
        comboSteps.innerHTML = confirmMode
          ? '1. Drinks ¬∑ <strong>2. Confirm</strong>'
          : '<strong>1. Drinks</strong> ¬∑ 2. Confirm';
        comboContent.innerHTML = `
          <div class="selector-grid">
            ${pool.map(p=>`
              <div class="select-card" data-id="${p.id}">
                <div class="select-title">${p.name}</div>
                <div class="select-qty">
                  <button data-minus="${p.id}">‚àí</button>
                  <output data-out="${p.id}">${counts[p.id]||0}</output>
                  <button data-plus="${p.id}">+</button>
                </div>
              </div>`).join('')}
          </div>`;

        comboContent.querySelectorAll('[data-plus]').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const id = btn.getAttribute('data-plus');
            if (usedTotal(counts) < drinksNeeded){
              counts[id] = (counts[id]||0) + 1;
              renderGrid();
            }
          });
        });
        comboContent.querySelectorAll('[data-minus]').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const id = btn.getAttribute('data-minus');
            counts[id] = Math.max(0, (counts[id]||0) - 1);
            renderGrid();
          });
        });

        comboPrev.style.display='none';
        comboNext.textContent = confirmMode ? 'Add to Cart' : 'Next';
        comboNext.disabled = remaining>0;
      };

      const renderConfirm=()=>{
        comboTitle.textContent=item.name||'Confirm Selection';
        const fmt=id=>(findMenuItem(id)||{}).name||id;
        const drinkParts=Object.entries(counts)
          .filter(([,c])=>c>0)
          .map(([id,c])=>`${fmt(id)} x${c}`);
        comboSteps.innerHTML='1. Drinks ¬∑ <strong>2. Confirm</strong>';
        comboContent.innerHTML = `
          <div class="summary" style="gap:10px;">
            ${drinkParts.length
              ? `<div><strong>Drinks:</strong> ${drinkParts.join(', ')}</div>`
              : ''}
            ${item.description
              ? `<div class="small muted">${item.description}</div>`
              : ''}
          </div>`;
        comboPrev.style.display='none';
        comboNext.textContent='Add to Cart';
        comboNext.disabled=false;
      };

      comboPrev.onclick=()=>{};
      comboNext.onclick=()=>{
        if(!confirmMode){
          confirmMode=true;
          renderConfirm();
          return;
        }

        const fmt=id=>(findMenuItem(id)||{}).name||id;
        const drinkParts=Object.entries(counts)
          .filter(([,c])=>c>0)
          .map(([id,c])=>`${fmt(id)} x${c}`);
        const meta=drinkParts.length?`Drinks: ${drinkParts.join(', ')}`:'';

        // Main combo line
        addToCart({
          id:item.id,
          name:item.name,
          unitPrice:item.price,
          qty:qty||1,
          type:item.type,
          drinks:counts,
          meta
        });

        // Included entrees as zero-price lines for ingredient tracking
        if(item.includedEntrees){
          const q = qty||1;
          Object.entries(item.includedEntrees).forEach(([entId, perCombo])=>{
            const entItem = findMenuItem(entId);
            const entName = (entItem?entItem.name:'Item') + ' (Combo)';
            addToCart({
              id:entId,
              name:entName,
              unitPrice:0,
              qty:perCombo*q,
              type:'entree',
              meta:item.name
            });
          });
        }

        comboModal.close();
      };

      renderGrid();
      comboModal.showModal();
    }

    // ---------- Ingredients aggregation ----------

    function aggregateIngredients(){
      const tally={};
      const add=(n,x=1)=>{
        if(!n) return;
        tally[n]=(tally[n]||0)+x;
      };

      state.cart.forEach(line=>{
        if(RECIPE_MAP[line.id]){
          for(const [ing,c] of Object.entries(RECIPE_MAP[line.id])){
            add(ing, c*line.qty);
          }
        }
        if(line.drinks){
          for(const [drinkId,c] of Object.entries(line.drinks)){
            const rec = RECIPE_MAP[drinkId];
            if(rec){
              for(const [ing,n] of Object.entries(rec)){
                add(ing, n*c*(line.qty||1));
              }
            }
          }
        }
      });

      return tally;
    }

    function renderIngredients(){
      const wrap=document.getElementById('ingredientList');
      const entries=Object.entries(aggregateIngredients())
        .sort((a,b)=>a[0].localeCompare(b[0]));
      if(!entries.length){
        wrap.innerHTML='<div class="muted">No ingredients yet. Add items to the cart.</div>';
        return;
      }
      wrap.innerHTML = entries.map(([n,c])=>`
        <div class="ing-list">
          <div>${n}</div>
          <div><strong>x${c}</strong></div>
        </div>`).join('');
    }

    document.getElementById('copyIngBtn')?.addEventListener('click',()=>{
      const txt=Object.entries(aggregateIngredients())
        .sort((a,b)=>a[0].localeCompare(b[0]))
        .map(([n,c])=>`- ${n} x${c}`)
        .join('\n');
      navigator.clipboard.writeText(txt).then(()=>alert('Ingredients copied to clipboard!'));
    });

    document.getElementById('exportIngBtn')?.addEventListener('click',()=>{
      const rows=[
        ['Ingredient','Count'],
        ...Object.entries(aggregateIngredients())
          .sort((a,b)=>a[0].localeCompare(b[0]))
      ];
      const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='burgershot_ingredients.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    function renderAll(){
      renderCards();
      renderCart();
      renderFulfillment();
      renderTotals();
      renderDiscount();
      renderHistory();
    }

    // ---------- Checkout / Reset ----------

    function checkout(){
      if(!state.cart.length){
        alert('Your order is empty.');
        return;
      }
      const subtotal=state.cart.reduce((s,l)=>s+l.unitPrice*l.qty,0);
      const manual=+(subtotal*(state.discountPct/100)).toFixed(2);
      const promo=computePromotions();
      const fee=state.fulfillment==='delivery'
        ? (ZONE_FEES[state.deliveryZone]||0)
        : 0;
      const total=+(subtotal+fee-manual-promo.discount).toFixed(2);

      const entry={
        id:Date.now(),
        items:state.cart.map(l=>({
          id:l.id||null,
          name:l.name,
          qty:l.qty,
          unit:l.unitPrice,
          meta:l.meta||null,
          drinks:l.drinks||null,
          cakes:l.cakes||null,
          type:l.type||'extra',
          lineTotal:+(l.unitPrice*l.qty).toFixed(2)
        })),
        discountPct:state.discountPct,
        subtotal:+subtotal.toFixed(2),
        deliveryFee:fee,
        promoDiscount:promo.discount,
        manualDiscount:manual,
        total
      };
      state.history.unshift(entry);
      persistHistory();

      state.cart=[];
      state.discountPct=0;
      persist();
      renderAll();
      selectTab('summary');
    }

    function resetAll(){
      state.cart=[];
      state.discountPct=0;
      persist();
      renderAll();
      renderIngredients();
    }

    document.getElementById('checkoutBtn').addEventListener('click',checkout);
    document.getElementById('checkoutBtn2').addEventListener('click',checkout);
    document.getElementById('resetBtn').addEventListener('click',resetAll);
    document.getElementById('resetBtn2').addEventListener('click',resetAll);

    // ---------- Theme ----------

    const themeBtn=document.getElementById('themeBtn');
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme',t);
      localStorage.setItem('burgershot_theme',t);
      themeBtn.textContent=t==='dark'?'‚òÄÔ∏è Light':'üåô Dark';
      themeBtn.setAttribute('aria-pressed',t==='dark');
    }
    applyTheme(localStorage.getItem('burgershot_theme')||'light');
    themeBtn.addEventListener('click',()=>{
      const next=(localStorage.getItem('burgershot_theme')||'light')==='light'
        ? 'dark'
        : 'light';
      applyTheme(next);
    });

    // ---------- Init ----------

    renderAll();
  </script>
</body>
</html>
